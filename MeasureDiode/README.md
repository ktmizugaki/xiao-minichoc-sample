# 概要

スイッチ・ダイオードを charlieplex 方式で接続したとき、ゴーストが
発生しそうかどうかを実測により検証するための回路・スケッチである。

マイコンとして、 Seeeduino XIAO m0 (SAMD21G18A) マイコンを使用する。

# スイッチ押下の判定方式

スイッチ押下を判定する際、プルアップ方式とプルダウン方式が考えられる。
本スケッチでは、両方のパターンについて測定する。

## プルアップ方式について

プルアップ方式について説明する。

マイコンのIOとスイッチ・ダイオードが次のように接続しているとする。

```
IO1 → SW → AダイオードK → IO2
```

IO1を プルアップ入力 に、IO2を Low出力 に(GNDへ接続)し、IO1を読み取ることで、
スイッチ押下を判定するのが プルアップ方式 となる。

スイッチOFF状態ならば、プルアップにより読み取り値が High となり、
スイッチON状態ならば、IO1がダイオードを介してGNDに接続され、読み取り値が Low となる。

## プルダウン方式について

プルダウン方式について説明する。

マイコンのIOとスイッチ・ダイオードが次のように接続しているとする。

```
IO2 → SW → AダイオードK → IO3
```

IO2を High出力 に(Vddへ接続)、IO3を プルダウン入力 にし、IO3を読み取ることで、
スイッチ押下を判定するのが プルダウン方式 となる。

スイッチOFF状態ならば、プルダウンにより読み取り値が Low となり、
スイッチON状態ならば、IO3がダイオードを介してVddに接続され、読み取り値が High となる。

# charlieplex 方式について

charlieplex とは、少ないIOピンで多くのLEDを独立してON/OFFする接続方法である。
N 個の IOピン を使用すると、 N × (N-1) 個のLEDを制御できる。

これを、キーボードスイッチのマトリックスに応用する。

各IOピンnについて、他のすべてのIOピンmに対し、スイッチとダイオードを次のように接続する。

```
IOn → SW → AダイオードK → IOm (m ≠ n)
```

3つのIOを使用した場合、接続は次のようになる。

```
IO1 → SW → AダイオードK → IO2
IO1 → SW → AダイオードK → IO3
IO2 → SW → AダイオードK → IO1
IO2 → SW → AダイオードK → IO3
IO3 → SW → AダイオードK → IO1
IO3 → SW → AダイオードK → IO2
```

以降、簡単のため、 `IOn → SW → AダイオードK → IOm` を `IOn → IOm` と表記する。

スイッチの状態をプルアップ方式で読み取るには次のようにする。

1. すべての IO を プルアップあり入力にする。
2. IO1 を Low 出力にする。
3. `IO2 → IO1` のスイッチを読み取るため IO2 の値を読み取る。
4. `IO3 → IO1` のスイッチを読み取るため IO3 の値を読み取る。
5. IO1 を プルアップあり入力に戻す。
6. IO2～IO3 について、 2～5 と同様の処理を行う。

例えば `IO1 → IO3` のスイッチのみが ON になった場合、
IO3 を Low 出力にして IO1 の値を読み取った時のみ、IO1の読み取り値が Low となる。

ダイオードがあることで、 `IO3 → IO1` のスイッチが ON であっても、
`IO1 → IO3` のスイッチの読み取りに影響がない。

# ゴースト

charlieplex 方式では、2つのスイッチが ON になった場合、ゴーストが発生する可能性がある。

例えば `IO1 → IO2` のスイッチと `IO2 → IO3` のスイッチのみが ON になった場合、
回路は次と同様の状態になる。IO1からIO3はダイオードで接続されるため、
IO3 を Low 出力にすると IO1 の読み取り値が Low となり、
`IO1 → IO3` のスイッチが ON の状態との区別が付かなくなってしまう。

```
IO1 → AダイオードK → IO2 → AダイオードK → IO3
```

このように、本来押されていないスイッチが押されているように認識されてしまう現象をゴーストと呼ぶ。

ここで、ダイオードには電圧降下 Vf があり、マイコンの ピン入力 には、
Low読み取りとなる最高電圧 VIL と High読み取りとなる最低電圧 VIH がある。

`IO1 → IO3` のスイッチが ON の場合、 IO1 の電圧は Vf になる。
`IO2 → IO3` のスイッチが OFFで、`IO1 → IO2` のスイッチと `IO2 → IO3` の
スイッチが ON の場合、 IO1 の電圧は 2×Vf になる。

従って、プルアップ方式の場合 Vf が VIL 以下、 2×Vf が VIH以上であれば、
`IO1 → IO3` のスイッチが ON の時のみ IO1 の読み取り値が Low となり、
2キー入力に対応できるということになる。

# ダイオードの Vf の条件

SAMD21G18A では、電源電圧を Vdd として、Low になる電圧 VIL、High となる電圧 VIH が、
次の表のように規定されている。

| symbol | value      | actual   |
|:-------|-----------:|---------:|
| Vdd    | 2.7V-3.63V |     3.3V |
| VIL    |  <=0.3*Vdd |  <=0.99V |
| VIH    | >=0.55*Vdd | >=1.815V |

プルアップ方式の場合、ダイオードの Vf は次の条件を満たす必要がある。

```
1*Vf < 0.99
2*Vf > 1.815
0.9075 < Vf < 0.99
∴ Vf = 0.948±0.04
```

また、2つのダイオードを直列接続するとすると、ダイオードの Vf の条件は次のようになる。

```
Vf = 0.474±0.02
```

同様に、プルダウン方式の場合、ダイオードの Vf は次の条件を満たす必要がある。

```
3.3 - 1*Vf > 1.815
3.3 - 2*Vf < 0.99
1.155 < Vf < 1.485
∴ Vf = 1.32±0.16
```

また、2つのダイオードを直列接続するとすると、ダイオードの Vf の条件は次のようになる。

```
Vf = 0.66±0.08
```

# 回路の内容

本回路は、 IO1, IO2, IO3 の3つの IO を使用した charlieplex 方式のキーマトリックスで、
`IO1 → IO2`、 `IO2 → IO3` のスイッチが ON であり、それ以外の `IO1 → IO3`、
`IO2 → IO1`、 ... のスイッチが OFF である状態と
等価な回路となっている。

抵抗が追加されているのは、IO1を High 出力、 IO2 を Low 出力にした時に、
過電流が流れないようにするための保護用である。

# スケッチの内容

本スケッチでは、シリアルでエンターキーを入力すると、下記4つのパターンで計測を行う。

|     | IO1 | IO2 | IO3 | | Measure at  |
|-----|-----|-----|-----|-|-------------|
| (1) | Ipu | L   | Ipu | | IO1/Analog1 |
| (2) | Ipu | Ipu | L   | | IO1/Analog1 |
| (3) | Ipd | H   | Ipd | | IO3/Analog3 |
| (4) | H   | Ipd | Ipd | | IO3/Analog3 |

ここで、 IO の測定は、通常のキー検出同様、デジタル値を読み取って表示する。
また、 Analog の測定では、電圧を読み取って表示し、
入力電圧がマイコンの仕様の範囲に収まっているかを確認する。
例えば、仮にデジタル値 が 1 であっても、電圧が 1.3V であったら、
安定して動作することが期待できないと考えられる。

`(1)` は、プルアップ方式を使用した際に、スイッチ ON のキーを正しく読み取れるかを測定する。
`IO1 → IO2` は、スイッチ ON 状態であるため、読み取り値が Low である必要がある。

`(2)` は、プルアップ方式を使用した際に、ゴーストが発生するかどうかを測定する。
`IO1 → IO3` は、スイッチ OFF 状態であるため、読み取り値が High である必要がある。

読み取り値が Low となった場合、 `IO1 → IO2` と `IO2 → IO3` のスイッチを
ON にしているだけなのに `IO1 → IO3` のスイッチも ON と判定されてしまう、
すなわちゴーストが発生した状態となる。

`(3)` は、プルダウン方式を使用した際に、スイッチ ON のキーを正しく読み取れるかを測定する。
`IO2 → IO3` は、スイッチ ON 状態であるため、IO3の 読み取り値が High である必要がある。

`(4)` は、プルダウン方式を使用した際に、ゴーストが発生するかどうかを測定する。
`IO1 → IO3` は、スイッチ OFF 状態であるため、読み取り値が Low である必要がある。

読み取り値が Low となった場合、 `IO1 → IO2` と `IO2 → IO3` のスイッチを
ON にしているだけなのに `IO1 → IO3` のスイッチも ON と判定されてしまう、
すなわちゴーストが発生した状態となる。


プルアップ方式で複数キー入力に対応するためには、
測定結果が次のテーブルの条件を満たしている必要がある。

| IO1 | IO2 | IO3 | | D | Analog |
|-----|-----|-----|-|--:|-------:|
| Ipu | L   | Ipu | | 0 |  <0.99 |
| Ipu | Ipu | L   | | 1 | >1.815 |

同様に、プルダウン方式で複数キー入力に対応するためには、
測定結果が次のテーブルの条件を満たしている必要がある。

| IO1 | IO2 | IO3 | | D | Analog |
|-----|-----|-----|-|--:|-------:|
| Ipd | H   | Ipd | | 1 | >1.815 |
| H   | Ipd | Ipd | | 0 |  <0.99 |
